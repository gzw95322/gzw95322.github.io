<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="keywords" content="undefined">
  <meta name="description" content="郭志伟的前端小窝">
  <meta name="author" content="gzw">
  <meta name="robots" content="undefined">
  <meta name="msapplication-TileColor" content="#455A64">
  <meta name="theme-color" content="#455A64">
  
    <title>
      
        angularjs+plupload实现sts临时授权上传文件到oss |
          
            sprialmint
    </title>
    
      <link rel="icon" href="/favicon.ico">
      <!-- <link rel='stylesheet' id='open-sans-css'  href='https://fonts.lug.ustc.edu.cn/css?family=Open+Sans%3A300italic%2C400italic%2C600italic%2C300%2C400%2C600&#038;subset=latin%2Clatin-ext' type='text/css' media='all' /> -->
      
      
        <link rel="stylesheet" href="/css/style.css">
        <link rel="stylesheet" href="//at.alicdn.com/t/font_596123_b7axjvh0br1z6w29.css">
</head>
<body>
    
<header id="header" class="animited clearfix">
  <div class="header-bg"></div>
    <h1>sprialmint <small>郭志伟的前端小窝</small></h1>
    <button type="button" class="nav-toggle">
       <span></span>
       <span></span>
       <span></span>
    </button>
    <nav>
      
      
      <a href="/">Home</a>
    
      
      <a href="/archives">Archives</a>
    
      
      <a href="/life">Life</a>
    
      
      <a href="/about">About</a>
    
    </nav>
</header>
    <article id="article">
            <section>
    <summary class="title">
        angularjs+plupload实现sts临时授权上传文件到oss    </summary>
    
            <div class="date">
                周三 2016-10-12 00:00
            </div>
            
                <p class="sub">
                    </p><p>#Angularjs+plupload实现STS临时授权上传文件到OSS</p>
<p>这个不能算是原创，是基于阿里云官方文档中提供的实例修改实现的，我只是对官方的实例做了STS授权处理和ng组件化。官方实例地址：<a href="https://help.aliyun.com/document_detail/31925.html?spm=5176.doc31923.2.1.IAnkDb" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/31925.html?spm=5176.doc31923.2.1.IAnkDb</a>。<br><a id="more"></a><br><strong>首先</strong>需要说明的是，js开发最好使用严格模式就是在js文件的开头添加<code>&#39;use strict&#39;</code>语句，虽然js语言很随意，但是不严格把控很容易出错，并误导代码阅读者。</p>
<p>这里我把实例进行了ng组件化，在html中只要调用对应的自定义标签即可。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">fupload</span> <span class="attr">dir</span>=<span class="string">"enterprise/"</span> <span class="attr">fdata</span>=<span class="string">"data.img"</span> <span class="attr">fimg</span>=<span class="string">"fnamee"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"ossfile"</span> <span class="attr">class</span>=<span class="string">"alert alert-default alert-fu"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"console"</span> <span class="attr">class</span>=<span class="string">"alert alert-danger alert-fu"</span> <span class="attr">style</span>=<span class="string">"padding:10px 7px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span> <span class="attr">style</span>=<span class="string">"width: 400px;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"img"</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">readonly</span> <span class="attr">ng-model</span>=<span class="string">"data.img"</span> <span class="attr">required</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-control input-sm"</span> <span class="attr">id</span>=<span class="string">"text_skin"</span>&gt;</span>&#123;&#123;fnamee&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"input-group-btn"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary btn-sm"</span> <span class="attr">id</span>=<span class="string">"selectfiles"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>上传文件<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">fupload</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>参数说明</p>
<table>
<thead>
<tr>
<th>类</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dir</code></td>
<td>文件的上传路径，决定文件在OSS服务器中的存放位置。</td>
</tr>
<tr>
<td><code>fdata</code></td>
<td>表单中需要存放数据库的字段，双向绑定。</td>
</tr>
<tr>
<td><code>fimg</code></td>
<td>表单中显示的文件名称，可不填，这里我只想把文件的名称显示在页面上</td>
</tr>
</tbody>
</table>
<p>这个后期是可以调整了，根据实际的项目需求决定。</p>
<ul>
<li><code>&lt;div id=&quot;ossfile&quot;&gt;&lt;/div&gt;</code>、<code>&lt;div id=&quot;console&quot;&gt;&lt;/div&gt;</code>这两个标签为上传信息的显示框，一个显示上传进度，一个显示错误信息。</li>
</ul>
<p>具体的效果图：</p>
<p><img src="https://ws2.sinaimg.cn/mw690/005AePdbly1fm775elqwcj30en02nt8l.jpg" alt="效果"></p>
<p><img src="https://ws2.sinaimg.cn/mw690/005AePdbly1fm775f8nvgj30fj02hgll.jpg" alt="效果"></p>
<p>下面是ng的一些代码：</p>
<p>controller：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">.controller(<span class="string">'qiyesubController'</span>, [<span class="string">'$scope'</span>, <span class="string">'LsSear'</span>,</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">$scope, LsSear</span>) </span>&#123;</span><br><span class="line">        $scope.data = &#123;&#125;;</span><br><span class="line">        $scope.fnamee = <span class="string">''</span>;</span><br><span class="line">        $scope.sub = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            LsSear.userList(<span class="string">'&lt;your url&gt;'</span>, $scope.data)</span><br><span class="line">                .success(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (data.state == <span class="string">"success"</span>) &#123;</span><br><span class="line">                        alert(<span class="string">"信息提交成功"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        alert(<span class="string">"信息提交失败"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .error(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">                    alert(<span class="string">"系统错误，请稍后重试！"</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>其中的<code>LsSear</code>是我把ng的<code>$http.post</code>给写成了service，方便调用。</p>
<p>directive：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//文件上传</span></span><br><span class="line">.directive(<span class="string">"fupload"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">sts, oss_host, oss_dir, $timeout</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        scope: &#123;</span><br><span class="line">            fdata: <span class="string">'=fdata'</span>,</span><br><span class="line">            fimg: <span class="string">'=fimg'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">//若需指定上传路径，在调用的标签上添加属性”dir="&lt;your dir&gt;"“即可</span></span><br><span class="line">        <span class="comment">/*scope:&#123;</span></span><br><span class="line"><span class="comment">            oss_dir:'@dir';</span></span><br><span class="line"><span class="comment">            fdata:'=fdata'</span></span><br><span class="line"><span class="comment">        &#125;,*/</span></span><br><span class="line">        link: <span class="function"><span class="keyword">function</span>(<span class="params">scope, element, attrs</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> accessid = <span class="string">''</span>,</span><br><span class="line">                accesskey = <span class="string">''</span>,</span><br><span class="line">                host = oss_host,</span><br><span class="line">                stsToken = <span class="string">''</span>,</span><br><span class="line">                policyText = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> g_dirname = <span class="string">''</span>,</span><br><span class="line">                g_object_name = <span class="string">''</span>,</span><br><span class="line">                g_object_name_type = <span class="string">''</span>,</span><br><span class="line">                now = <span class="built_in">Date</span>.parse(<span class="keyword">new</span> <span class="built_in">Date</span>()) / <span class="number">1000</span>,</span><br><span class="line">                timestamp = <span class="built_in">Date</span>.parse(<span class="keyword">new</span> <span class="built_in">Date</span>()) / <span class="number">1000</span>,</span><br><span class="line">                policyBase64 = <span class="string">''</span>,</span><br><span class="line">                signature = <span class="string">''</span>,</span><br><span class="line">                btn_style = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">send_request</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> xmlhttp = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">window</span>.XMLHttpRequest) &#123;</span><br><span class="line">                    xmlhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">window</span>.ActiveXObject) &#123;</span><br><span class="line">                    xmlhttp = <span class="keyword">new</span> ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (xmlhttp != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> serverUrl = sts</span><br><span class="line">                    xmlhttp.open(<span class="string">"GET"</span>, serverUrl, <span class="literal">false</span>);</span><br><span class="line">                    xmlhttp.send(<span class="literal">null</span>);</span><br><span class="line">                    <span class="keyword">return</span> xmlhttp.responseText</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    alert(<span class="string">"Your browser does not support XMLHTTP."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">get_signature</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> body = send_request();</span><br><span class="line">                <span class="keyword">var</span> obj = <span class="built_in">eval</span>(<span class="string">"("</span> + body + <span class="string">")"</span>);</span><br><span class="line">                accessid = obj[<span class="string">'AccessKeyId'</span>]</span><br><span class="line">                accesskey = obj[<span class="string">'AccessKeySecret'</span>]</span><br><span class="line">                stsToken = obj[<span class="string">'SecurityToken'</span>]</span><br><span class="line">                policyText = &#123;</span><br><span class="line">                    <span class="string">"expiration"</span>: obj[<span class="string">'Expiration'</span>],</span><br><span class="line">                    <span class="string">"conditions"</span>: [</span><br><span class="line">                        [<span class="string">"content-length-range"</span>, <span class="number">0</span>, <span class="number">1048576000</span>] <span class="comment">// 设置上传文件的大小限制</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;;</span><br><span class="line">                policyBase64 = Base64.encode(<span class="built_in">JSON</span>.stringify(policyText))</span><br><span class="line">                <span class="keyword">var</span> message = policyBase64</span><br><span class="line">                <span class="keyword">var</span> bytes = Crypto.HMAC(Crypto.SHA1, message, accesskey, &#123; <span class="attr">asBytes</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">                signature = Crypto.util.bytesToBase64(bytes);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">check_object_radio</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                g_object_name_type = <span class="string">'random_name'</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">get_dirname</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                g_dirname = oss_dir;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">random_string</span>(<span class="params"></span>) </span>&#123;　　</span><br><span class="line">                <span class="keyword">var</span> chars = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),</span><br><span class="line">                    rad = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">10000</span>);</span><br><span class="line">                <span class="keyword">var</span> pwd = <span class="string">''</span>;　　</span><br><span class="line">                pwd = chars.toString() + rad.toString();</span><br><span class="line">                <span class="keyword">return</span> pwd;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">get_suffix</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> pos = filename.lastIndexOf(<span class="string">'.'</span>)</span><br><span class="line">                <span class="keyword">var</span> suffix = <span class="string">''</span></span><br><span class="line">                <span class="keyword">if</span> (pos != <span class="number">-1</span>) &#123;</span><br><span class="line">                    suffix = filename.substring(pos)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> suffix;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">calculate_object_name</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (g_object_name_type == <span class="string">'local_name'</span>) &#123;</span><br><span class="line">                    g_object_name += <span class="string">"$&#123;filename&#125;"</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (g_object_name_type == <span class="string">'random_name'</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> suffix = get_suffix(filename)</span><br><span class="line">                    g_object_name = g_dirname + random_string() + suffix</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">get_uploaded_object_name</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (g_object_name_type == <span class="string">'local_name'</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> tmp_name = g_object_name</span><br><span class="line">                    tmp_name = tmp_name.replace(<span class="string">"$&#123;filename&#125;"</span>, filename);</span><br><span class="line">                    <span class="keyword">return</span> tmp_name</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (g_object_name_type == <span class="string">'random_name'</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> g_object_name</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">set_upload_param</span>(<span class="params">up, filename, ret</span>) </span>&#123;</span><br><span class="line">                g_object_name = g_dirname;</span><br><span class="line">                <span class="keyword">if</span> (ret == <span class="literal">false</span>) &#123;</span><br><span class="line">                    get_signature()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (filename != <span class="string">''</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> suffix = get_suffix(filename)</span><br><span class="line">                    calculate_object_name(filename)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> new_multipart_params = &#123;</span><br><span class="line">                    <span class="string">'key'</span>: g_object_name,</span><br><span class="line">                    <span class="string">'policy'</span>: policyBase64,</span><br><span class="line">                    <span class="string">'OSSAccessKeyId'</span>: accessid,</span><br><span class="line">                    <span class="string">'success_action_status'</span>: <span class="string">'200'</span>,</span><br><span class="line">                    <span class="string">'signature'</span>: signature,</span><br><span class="line">                    <span class="string">'x-oss-security-token'</span>: stsToken</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                up.setOption(&#123;</span><br><span class="line">                    <span class="string">'url'</span>: host,</span><br><span class="line">                    <span class="string">'multipart_params'</span>: new_multipart_params</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                up.start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> uploader = <span class="keyword">new</span> plupload.Uploader(&#123;</span><br><span class="line">                runtimes: <span class="string">'html5,flash,silverlight,html4'</span>,</span><br><span class="line">                browse_button: <span class="string">'selectfiles'</span>,</span><br><span class="line">                multi_selection: <span class="literal">false</span>,</span><br><span class="line">                container: <span class="built_in">document</span>.getElementById(<span class="string">'container'</span>),</span><br><span class="line">                flash_swf_url: <span class="string">'bower_components/oss/lib/plupload-2.1.2/js/Moxie.swf'</span>,</span><br><span class="line">                silverlight_xap_url: <span class="string">'bower_components/oss/lib/plupload-2.1.2/js/Moxie.xap'</span>,</span><br><span class="line">                url: <span class="string">'http://oss.aliyuncs.com'</span>,</span><br><span class="line">                filters: &#123;</span><br><span class="line">                    mime_types: [ <span class="comment">//只允许上传图片和zip,rar文件</span></span><br><span class="line">                        &#123; <span class="attr">title</span>: <span class="string">"Image files"</span>, <span class="attr">extensions</span>: <span class="string">"jpg,gif,png,bmp"</span> &#125;,</span><br><span class="line">                        &#123; <span class="attr">title</span>: <span class="string">"Zip files"</span>, <span class="attr">extensions</span>: <span class="string">"zip,rar"</span> &#125;,</span><br><span class="line">                        &#123; <span class="attr">title</span>: <span class="string">"Office files"</span>, <span class="attr">extensions</span>: <span class="string">"doc,docx,xls,xlsx,pdf,ppt,pptx,csv"</span> &#125;</span><br><span class="line">                    ],</span><br><span class="line">                    max_file_size: <span class="string">'10mb'</span>, <span class="comment">//最大只能上传10mb的文件</span></span><br><span class="line">                    prevent_duplicates: <span class="literal">true</span> <span class="comment">//不允许选取重复文件</span></span><br><span class="line">                &#125;,</span><br><span class="line"></span><br><span class="line">                init: &#123;</span><br><span class="line">                    PostInit: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                        <span class="built_in">document</span>.getElementById(<span class="string">'ossfile'</span>).innerHTML = <span class="string">''</span>;</span><br><span class="line">                        <span class="comment">/*document.getElementById('postfiles').onclick = function() &#123;</span></span><br><span class="line"><span class="comment">                            set_upload_param(uploader, '', false);</span></span><br><span class="line"><span class="comment">                            return false;</span></span><br><span class="line"><span class="comment">                        &#125;;*/</span></span><br><span class="line">                    &#125;,</span><br><span class="line"></span><br><span class="line">                    FilesAdded: <span class="function"><span class="keyword">function</span>(<span class="params">up, files</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">var</span> btn_s = <span class="built_in">document</span>.getElementById(<span class="string">'selectfiles'</span>).getAttribute(<span class="string">"class"</span>);</span><br><span class="line">                        btn_style = btn_s;</span><br><span class="line">                        <span class="built_in">document</span>.getElementById(<span class="string">'selectfiles'</span>).setAttribute(<span class="string">"class"</span>, btn_s + <span class="string">" disabled"</span>);</span><br><span class="line">                        plupload.each(files, <span class="function"><span class="keyword">function</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">                            <span class="built_in">document</span>.getElementById(<span class="string">'ossfile'</span>).innerHTML = <span class="string">'&lt;div id="'</span> + file.id + <span class="string">'"&gt;&lt;span class="fname"&gt;'</span> + file.name + <span class="string">'&lt;/span&gt; &lt;span class="fsize"&gt;'</span> + plupload.formatSize(file.size) + <span class="string">'&lt;/span&gt;'</span> + <span class="string">'&lt;div class="progress fpgre"&gt;&lt;div class="progress-bar progress-bar-success progress-bar-striped active" style="width: 0%"&gt;&lt;b&gt;&lt;/b&gt;&lt;/div&gt;&lt;/div&gt;'</span> + <span class="string">'&lt;/div&gt;'</span>;</span><br><span class="line">                            <span class="built_in">document</span>.getElementById(<span class="string">'ossfile'</span>).style.display = <span class="string">"block"</span>;</span><br><span class="line">                        &#125;);</span><br><span class="line">                        set_upload_param(uploader, <span class="string">''</span>, <span class="literal">false</span>);</span><br><span class="line">                    &#125;,</span><br><span class="line"></span><br><span class="line">                    BeforeUpload: <span class="function"><span class="keyword">function</span>(<span class="params">up, file</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (accessid == <span class="string">"403"</span>) &#123;</span><br><span class="line">                            <span class="built_in">document</span>.getElementById(<span class="string">'console'</span>).innerHTML = <span class="string">"请重新登陆！"</span>;</span><br><span class="line">                            <span class="built_in">document</span>.getElementById(<span class="string">'console'</span>).style.display = <span class="string">"block"</span>;</span><br><span class="line">                            up.stop();</span><br><span class="line">                            up.removeFile(file);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (accessid == <span class="string">"402"</span>) &#123;</span><br><span class="line">                            <span class="built_in">document</span>.getElementById(<span class="string">'console'</span>).innerHTML = <span class="string">"文件库容量已满！请联系服务商"</span>;</span><br><span class="line">                            <span class="built_in">document</span>.getElementById(<span class="string">'console'</span>).style.display = <span class="string">"block"</span>;</span><br><span class="line">                            up.stop();</span><br><span class="line">                            up.removeFile(file);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            check_object_radio();</span><br><span class="line">                            get_dirname();</span><br><span class="line">                            set_upload_param(up, file.name, <span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line"></span><br><span class="line">                    UploadProgress: <span class="function"><span class="keyword">function</span>(<span class="params">up, file</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">var</span> d = <span class="built_in">document</span>.getElementById(file.id);</span><br><span class="line">                        <span class="keyword">if</span> (d.getElementsByTagName(<span class="string">'b'</span>) != <span class="literal">undefined</span>) &#123;</span><br><span class="line">                            d.getElementsByTagName(<span class="string">'b'</span>)[<span class="number">0</span>].innerHTML = file.percent + <span class="string">"%"</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">var</span> prog = d.getElementsByTagName(<span class="string">'div'</span>)[<span class="number">0</span>];</span><br><span class="line">                        <span class="keyword">var</span> progBar = prog.getElementsByTagName(<span class="string">'div'</span>)[<span class="number">0</span>];</span><br><span class="line">                        progBar.style.width = file.percent + <span class="string">'%'</span>;</span><br><span class="line">                        progBar.setAttribute(<span class="string">'aria-valuenow'</span>, file.percent);</span><br><span class="line">                    &#125;,</span><br><span class="line"></span><br><span class="line">                    FileUploaded: <span class="function"><span class="keyword">function</span>(<span class="params">up, file, info</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (info.status == <span class="number">200</span>) &#123;</span><br><span class="line">                            <span class="built_in">document</span>.getElementById(<span class="string">'selectfiles'</span>).setAttribute(<span class="string">"class"</span>, btn_style);</span><br><span class="line">                            setTimeout(<span class="string">"document.getElementById('ossfile').style.display='none'"</span>, <span class="number">1000</span>);</span><br><span class="line">                            $timeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                                scope.fdata = oss_host + <span class="string">'/'</span> + get_uploaded_object_name(file.name);</span><br><span class="line">                                scope.fimg = file.name;</span><br><span class="line">                            &#125;, <span class="number">1000</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="built_in">document</span>.getElementById(file.id).getElementsByTagName(<span class="string">'b'</span>)[<span class="number">0</span>].innerHTML = info.response;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">Error</span>: <span class="function"><span class="keyword">function</span>(<span class="params">up, err</span>) </span>&#123;</span><br><span class="line">                        <span class="built_in">document</span>.getElementById(<span class="string">'console'</span>).innerHTML = <span class="string">""</span>;</span><br><span class="line">                        <span class="built_in">document</span>.getElementById(<span class="string">'console'</span>).style.display = <span class="string">'block'</span>;</span><br><span class="line">                        <span class="keyword">if</span> (err.code == <span class="number">-600</span>) &#123;</span><br><span class="line">                            <span class="built_in">document</span>.getElementById(<span class="string">'console'</span>).appendChild(<span class="built_in">document</span>.createTextNode(<span class="string">"\n文件大小不能超过10MB！"</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err.code == <span class="number">-601</span>) &#123;</span><br><span class="line">                            <span class="built_in">document</span>.getElementById(<span class="string">'console'</span>).appendChild(<span class="built_in">document</span>.createTextNode(<span class="string">"\n不允许上传的文件类型！"</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err.code == <span class="number">-602</span>) &#123;</span><br><span class="line">                            <span class="built_in">document</span>.getElementById(<span class="string">'console'</span>).appendChild(<span class="built_in">document</span>.createTextNode(<span class="string">"\n这个文件已经上传过一遍了！"</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="built_in">document</span>.getElementById(<span class="string">'console'</span>).appendChild(<span class="built_in">document</span>.createTextNode(<span class="string">"\n系统异常，请稍后重试！"</span>));</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">"\nError xml:"</span> + err.response);</span><br><span class="line">                        &#125;</span><br><span class="line">                        setTimeout(<span class="string">"document.getElementById('console').style.display='none'"</span>, <span class="number">3000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            uploader.init();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里在directive声明中的<code>sts, oss_host, oss_dir</code>是我声明的constant全局变量，方便调用和配置。<br>对于ng中的constant用法请自行百度。参数说明如下：</p>
</blockquote>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>sts</td>
<td>sts临时授权请求地址</td>
</tr>
<tr>
<td>oss_host</td>
<td>oss上bucket的地址</td>
</tr>
<tr>
<td>oss_dir</td>
<td>oss的默认存放地址，这里由于项目的需要，我直接设置了一个存放地址。</td>
</tr>
</tbody>
</table>
<hr>
<p>###代码说明</p>
<p>######功能的实现逻辑：<br>1.访问STS地址获取STS临时授权。<br>2.将STS授权信息加入到plupload配置中。<br>3.上传文件到OSS。</p>
<p>在代码中主要的代码是OSS信息的填写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> new_multipart_params = &#123;</span><br><span class="line">    <span class="string">'key'</span>: g_object_name,</span><br><span class="line">    <span class="string">'policy'</span>: policyBase64,</span><br><span class="line">    <span class="string">'OSSAccessKeyId'</span>: accessid,</span><br><span class="line">    <span class="string">'success_action_status'</span>: <span class="string">'200'</span>,</span><br><span class="line">    <span class="string">'signature'</span>: signature,</span><br><span class="line">    <span class="string">'x-oss-security-token'</span>: stsToken</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>STS临时授权上传跟OSS直传所需要的验证信息是不一样的，如果使用STS需要上传的security-token，关于这个问题，官方文档给出的信息很隐蔽，需要结合STS和OSS的文档。</li>
<li>这里上传需要policy信息，由于是前台实现的，这里使用了crypto.js和base64.js的库对其进行的计算。</li>
<li>对于文件名称的命名格式：<strong>“当前时间戳+四位数字+文件后缀”</strong></li>
<li>对于STS授权信息的获取，我使用的是js原生的方法，ng的$http方法也可以，对STS授权信息的格式，这个根据需求和官方文档来设定。STS授权信息例子：</li>
</ul>
<p><img src="https://ws2.sinaimg.cn/mw690/005AePdbly1fm775fuckqj30o805fjsq.jpg" alt="例子"></p>
<ul>
<li>上传文件名称的设定开头不要出现<strong>“/”</strong>，否则会出现“InvalidObjectName”的错误。</li>
<li>对于数据双向绑定我是通过$timeout服务实现的。</li>
<li>plupload配置中的代码我就不一一说明，只是一些对dom的操作，相关的文档可以参考：<a href="http://http://www.cnblogs.com/2050/p/3913184.html" target="_blank" rel="noopener">http://www.cnblogs.com/2050/p/3913184.html</a></li>
</ul>
<p>附件下载：<a href="https://pan.baidu.com/s/1mhSpIAW" target="_blank" rel="noopener">https://pan.baidu.com/s/1mhSpIAW</a></p>
                <p></p>
                <div class="clearfix">
                    <div class="tags pull-left">
                        
                            


<span class="tag">angularjs</span> <span class="tag">oss</span> <span class="tag">plupload</span>
                                
                    </div>
                    <div class="share pull-right">
                          
<div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
   

                    </div>
                </div>
                <div class="license">
    <p><strong>原文链接：</strong><a href="http://www.sprialmint.com/2016/10/12/Angularjs+plupload实现STS临时授权上传文件到OSS/">http://www.sprialmint.com/2016/10/12/Angularjs+plupload实现STS临时授权上传文件到OSS/</a></p>
    <p><strong>版权声明：</strong>自由转载-非商用-非衍生-保持署名| <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" target="_blank">Creative Commons BY-NC-ND 4.0</a></p>
</div>
                      
   
   <!-- 来必力City版安装代码 -->
<div id="lv-container" data-id="city" data-uid="MTAyMC8zNTAyNC8xMTU2MA==">
	<script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
	</script>
<noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
</div>
<!-- City版安装代码已完成 -->

</section>
    </article>
    
<footer>
    <div>&copy; 2019 gzw
  powered_by &nbsp;<a href="http://hexo.io/" target="_blank">Hexo</a> &nbsp;theme by &nbsp;<a href="https://github.com/gzw95322/hexo-theme-stingy" target="_blank">stingy</a></div>
    <div class="footer-menu">
  <a href="http://www.miitbeian.gov.cn/" target="_blank">鲁ICP备16001540号</a>
</div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>

  <link rel="stylesheet" href="/css/gallery.css">
  <!-- fancybox is 3.x GPLv3 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>

<script src="/js/script.js"></script>


<div id="backtotop" class="animited pullback"><em></em><i></i><span>BACK<br>TO<br>TO<br>TOP</span></div>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?faa764cb53bbf9988c91a8fa2857a4d7";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
   
    
</body>

</html>
